<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strength Workout Logger</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a cleaner look */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light background */
        }
        /* Style for the table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        th, td {
            border: 1px solid #e2e8f0; /* Tailwind's gray-200 */
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background-color: #edf2f7; /* Tailwind's gray-100 */
            font-weight: 600;
            color: #2d3748; /* Tailwind's gray-800 */
        }
        tr:nth-child(even) {
            background-color: #f7fafc; /* Tailwind's gray-50 */
        }
        .message-box {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl mb-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Log Your Strength Workout</h1>

        <form id="workoutForm" class="space-y-6">
            <!-- Date Input -->
            <div>
                <label for="workoutDate" class="block text-sm font-medium text-gray-700 mb-1">Date:</label>
                <input type="date" id="workoutDate" name="workoutDate"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- Exercise Dropdown -->
            <div>
                <label for="exerciseSelect" class="block text-sm font-medium text-gray-700 mb-1">Exercise Name:</label>
                <select id="exerciseSelect" name="exerciseName"
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        required>
                    <option value="">-- Select an Exercise --</option>
                    <option value="add-new">-- Add New Exercise --</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <!-- New Exercise Input (hidden by default) -->
            <div id="newExerciseInputContainer" class="hidden">
                <label for="newExerciseName" class="block text-sm font-medium text-gray-700 mb-1">New Exercise Name:</label>
                <input type="text" id="newExerciseName" name="newExerciseName" placeholder="e.g., Bulgarian Split Squat"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>

            <!-- Sets Input -->
            <div>
                <label for="sets" class="block text-sm font-medium text-gray-700 mb-1">Sets:</label>
                <input type="number" id="sets" name="sets" min="1" value="3"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- Reps Input -->
            <div>
                <label for="reps" class="block text-sm font-medium text-gray-700 mb-1">Reps:</label>
                <input type="number" id="reps" name="reps" min="1" value="8"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- Weight Input -->
            <div>
                <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">Weight (kg/lbs):</label>
                <input type="number" id="weight" name="weight" step="0.5" value="0"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                       required>
            </div>

            <!-- Notes Textarea -->
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes:</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Any additional comments about your workout..."
                          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                Log Workout
            </button>
        </form>

        <!-- Message Box for feedback -->
        <div id="messageBox" class="mt-6 p-3 rounded-lg hidden message-box"></div>
    </div>

    <!-- Logged Workouts Display -->
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Your Logged Workouts</h2>
        <div id="workoutLog" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Exercise</th>
                        <th>Sets</th>
                        <th>Reps</th>
                        <th>Weight</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="workoutTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Workout rows will be populated by JavaScript -->
                    <tr>
                        <td colspan="6" class="text-center py-4 text-gray-500">No workouts logged yet.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p class="text-sm text-gray-500 mt-4 text-center">User ID: <span id="userIdDisplay">Loading...</span></p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated

        const workoutForm = document.getElementById('workoutForm');
        const messageBox = document.getElementById('messageBox');
        const workoutDateInput = document.getElementById('workoutDate');
        const exerciseSelect = document.getElementById('exerciseSelect');
        const newExerciseInputContainer = document.getElementById('newExerciseInputContainer');
        const newExerciseNameInput = document.getElementById('newExerciseName');
        const workoutTableBody = document.getElementById('workoutTableBody');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Function to display messages
        function showMessage(message, type = 'green') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (type === 'green') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); // Hide message after 3 seconds
        }

        // Initialize Firebase and set up authentication
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    console.log("User signed in:", userId);
                    // Setup Firestore listeners only after authentication is ready
                    setupFirestoreListeners();
                } else {
                    // Try to sign in with custom token, otherwise anonymously
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error during authentication:", error);
                        showMessage('Error authenticating. Data may not save.', 'red');
                    }
                }
            });
        } else {
            console.error("Firebase config is missing. Cannot initialize Firebase.");
            showMessage('Firebase is not configured. Data will not be saved.', 'red');
            userIdDisplay.textContent = 'Firebase Not Configured';
        }

        // Function to set up Firestore listeners
        function setupFirestoreListeners() {
            if (!db || !userId) {
                console.warn("Firestore or User ID not ready for listeners.");
                return;
            }

            // Listener for Exercises (for dropdown)
            const exercisesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/exercises`);
            onSnapshot(exercisesCollectionRef, (snapshot) => {
                const currentSelectedValue = exerciseSelect.value; // Store current selection
                exerciseSelect.innerHTML = '<option value="">-- Select an Exercise --</option><option value="add-new">-- Add New Exercise --</option>';
                snapshot.forEach((doc) => {
                    const exercise = doc.data().name;
                    const option = document.createElement('option');
                    option.value = exercise;
                    option.textContent = exercise;
                    exerciseSelect.appendChild(option);
                });
                // Attempt to restore previous selection, or default if 'add-new' was selected
                if (currentSelectedValue === 'add-new') {
                    exerciseSelect.value = 'add-new';
                    newExerciseInputContainer.classList.remove('hidden');
                } else if (Array.from(exerciseSelect.options).some(option => option.value === currentSelectedValue)) {
                    exerciseSelect.value = currentSelectedValue;
                } else {
                    exerciseSelect.value = ''; // Reset if the selected exercise was deleted or not found
                }
            }, (error) => {
                console.error("Error fetching exercises:", error);
                showMessage('Error loading exercises.', 'red');
            });

            // Listener for Workouts (for display table)
            const workoutsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/workouts`);
            // Note: orderBy is commented out as per instructions to avoid index issues.
            // Data will be sorted in JavaScript if needed.
            onSnapshot(workoutsCollectionRef, (snapshot) => {
                const workouts = [];
                snapshot.forEach((doc) => {
                    workouts.push({ id: doc.id, ...doc.data() });
                });

                // Sort workouts by date (descending) and then by timestamp if available
                workouts.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateB.getTime() - dateA.getTime(); // Sort by date
                    }
                    // If dates are the same, sort by timestamp if available
                    const timestampA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const timestampB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return timestampB.getTime() - timestampA.getTime();
                });

                workoutTableBody.innerHTML = ''; // Clear existing rows
                if (workouts.length === 0) {
                    workoutTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No workouts logged yet.</td></tr>';
                } else {
                    workouts.forEach(workout => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${workout.date}</td>
                            <td>${workout.exercise}</td>
                            <td>${workout.sets}</td>
                            <td>${workout.reps}</td>
                            <td>${workout.weight}</td>
                            <td>${workout.notes || '-'}</td>
                        `;
                        workoutTableBody.appendChild(row);
                    });
                }
            }, (error) => {
                console.error("Error fetching workouts:", error);
                showMessage('Error loading workouts.', 'red');
            });
        }

        // Set today's date as default
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        workoutDateInput.value = `${year}-${month}-${day}`;

        // Handle exercise dropdown change
        exerciseSelect.addEventListener('change', () => {
            if (exerciseSelect.value === 'add-new') {
                newExerciseInputContainer.classList.remove('hidden');
                newExerciseNameInput.focus();
            } else {
                newExerciseInputContainer.classList.add('hidden');
                newExerciseNameInput.value = ''; // Clear new exercise input
            }
        });

        // Form submission logic
        workoutForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            if (!db || !userId) {
                showMessage('Firebase not ready. Cannot log workout.', 'red');
                return;
            }

            let selectedExercise = exerciseSelect.value;

            // If 'Add New Exercise' was selected, use the new input field's value
            if (selectedExercise === 'add-new') {
                selectedExercise = newExerciseNameInput.value.trim();
                if (!selectedExercise) {
                    showMessage('Please enter a new exercise name.', 'red');
                    return;
                }
                // Add the new exercise to Firestore if it doesn't already exist
                const exerciseDocRef = doc(db, `artifacts/${appId}/users/${userId}/exercises`, selectedExercise.toLowerCase().replace(/\s/g, '-'));
                try {
                    await setDoc(exerciseDocRef, { name: selectedExercise }, { merge: true });
                } catch (e) {
                    console.error("Error adding new exercise:", e);
                    showMessage('Error adding new exercise.', 'red');
                    return;
                }
            } else if (!selectedExercise) {
                showMessage('Please select an exercise.', 'red');
                return;
            }

            // Gather form data
            const workoutData = {
                date: workoutDateInput.value,
                exercise: selectedExercise,
                sets: parseInt(document.getElementById('sets').value),
                reps: parseInt(document.getElementById('reps').value),
                weight: parseFloat(document.getElementById('weight').value),
                notes: document.getElementById('notes').value,
                timestamp: serverTimestamp() // Add a server timestamp for ordering
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/workouts`), workoutData);
                showMessage('Workout logged successfully!', 'green');
                workoutForm.reset(); // Clear the form after submission
                workoutDateInput.value = `${year}-${month}-${day}`; // Reset date to today
                exerciseSelect.value = ''; // Reset dropdown
                newExerciseInputContainer.classList.add('hidden'); // Hide new exercise input
                newExerciseNameInput.value = ''; // Clear new exercise input
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('Error logging workout. Please try again.', 'red');
            }
        });

        // Add initial recommended exercises if the collection is empty
        async function addInitialExercises() {
            if (!db || !userId) return;
            const initialExercises = [
                "Barbell Squat", "Deadlift", "Bench Press", "Overhead Press",
                "Bent-Over Row", "Pull-ups", "Dips", "Leg Press",
                "Bicep Curl", "Tricep Extension"
            ];

            const exercisesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/exercises`);
            const snapshot = await new Promise(resolve => {
                const unsubscribe = onSnapshot(exercisesCollectionRef, (snap) => {
                    unsubscribe(); // Unsubscribe after the first snapshot
                    resolve(snap);
                });
            });

            if (snapshot.empty) {
                console.log("Adding initial recommended exercises...");
                for (const exercise of initialExercises) {
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/exercises`, exercise.toLowerCase().replace(/\s/g, '-'));
                    try {
                        await setDoc(docRef, { name: exercise });
                    } catch (e) {
                        console.error(`Error adding initial exercise ${exercise}:`, e);
                    }
                }
            }
        }

        // Call this after authentication is confirmed
        // This will be called inside onAuthStateChanged after userId is set
        // addInitialExercises(); // This will be called by setupFirestoreListeners implicitly.
    </script>
</body>
</html>
